var fbAppId="146198745974205",reloadInterval=10*1000,lastReloadTime,countdownTime;$(function(){applyConfig(loadConfig());countdownTime=$(".countdown");$(".reactionGroup").hide();onFrame();applyConfig(loadConfig());countdownTime.click(function(){refresh()});$('[data-action="login"]').click(function(){FB.login(function(f){location.reload()},{scope:"user_photos,user_videos"})});FB.getLoginStatus(function(f){if(f.status!=="connected"){$(".login").show();$(".comments").hide();return}$(".comments").show();refresh()});$("button.sectionNavigation").click(function(k){k.preventDefault();var i=$(this).attr("href");var g=$("#room").val();if(i=="#firstScreen"){document.location.href="/"}else{if(i=="#alertClose"){$(".alert").hide()}else{if(i=="#uploadpage"){$(".uploadpage").show()}else{if(i=="#uploadClose"){$(".uploadpage").hide()}else{if(i=="#writerScreenInfo"){$(".writerScreenInfo").show();$("html").addClass("no-scroll")}else{if(i=="#writerScreenInfoClose"){$(".writerScreenInfo").hide();$("html").removeClass("no-scroll")}else{if(i=="#facebookLiveButton"){$(".editContainer").toggleClass("FacebookscreenVisible");$(".facebookLiveScreen,.facebookClose").toggle()}else{if(i=="#uploadButton"){if(!window.FileReader){alert("Your browser is not supported")}var h=$("#file").get(0);var f=new FileReader();if(h.files.length){var j=h.files[0];f.readAsText(j);$(f).on("load",c);$(".uploadpage").hide()}else{alert("Please upload a file before continuing")}}else{if(i=="#downloadButton"){b("DigitalAutocue",d())}else{if(i=="#fullscreen"){setConfigItem("fullscreen",!loadConfig().fullscreen)}else{console.log(i+": There was a button that won't work, Report to the developer");alert(i+": Report to developer")}}}}}}}}}}});function b(f,i){var h=new Date();f=f+"_"+h.toLocaleDateString()+"_"+h.getHours()+"-"+h.getMinutes()+"-"+h.getSeconds()+".txt";var g=document.createElement("a");g.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i));g.setAttribute("download",f);g.style.display="none";document.body.appendChild(g);g.click();document.body.removeChild(g)}function d(){var j="",g;g=document.getElementById("messageWriter").getElementsByTagName("p");for(var h=2,f=g.length;h<f;h++){j+=g[h].innerHTML+"\n"}return j}function c(h){var g=h.target.result,f;if(g&&g.length){f=g.split("\n");for(index=0,len=f.length;index<len;++index){a.emit("chat message",{room:e,msg:f[index]})}}}var a=io.connect();var a=io();var e;if(localStorage.config!==null&&localStorage.config!=""){e=loadConfig().room}else{document.location.href="/"}a.on("connect",function(){console.log("writer: "+e);a.emit("room",e)});$("#m").bind("keypress",function(f){if((f.keyCode||f.which)==13){$(this).parents("form").submit();return false}});$("#inputForm").submit(function(f){a.emit("chat message",{room:e,msg:$("#m").val()});$("#m").val("");return false});a.on("chat message",function(f){console.log("Successfully send: "+f);$(".messagesWrite").append('<div><p contenteditable="false">'+f+"</p></div>");$("#m").focus();document.body.scrollIntoView(false)});a.on("controlls",function(g,f){if(g=="alert"){$(".alert-text").text("There is a problem reported");$(".alert").show()}else{console.log(f+": Unknown error in controlls, report to developer")}})});if(!fbAppId){alert("You must set a Facebook Graph API app ID in js/main.js to use this application.")}function fbApi(a,d,b,c){return jQuery.Deferred(function(e){if(c){e.then(c)}FB.api(a,d,b,function(f){if(!f||f.error){return e.reject(f.error||f)}e.resolve(f)})}).promise()}function getLastLiveVideo(){return fbApi("/me/live_videos","get",{broadcast_status:["LIVE"],limit:1}).then(function(a){if(!a.data||!a.data[0]){throw new Error("No live videos found.")}return a.data[0]})}function getComments(a){return fbApi("/"+encodeURIComponent(a)+"/comments","get",{order:"reverse_chronological"}).then(function(b){if(!b||!b.data||!b.data.length){throw new Error("No recent comments.")}return b.data})}function getReactions(a){return fbApi("/"+encodeURIComponent(a)+"/reactions","get").then(function(c){var b={};if(!c||!c.data||!c.data.length){return b}c.data.forEach(function(d){d.type=d.type.toLowerCase();b[d.type]=b[d.type]||0;b[d.type]++});return b})}function refresh(){countdownTime.removeAttr("value");lastReloadTime=null;return getLastLiveVideo().then(function(a){return $.when(getComments(a.id),getReactions(a.id)).then(function(c,b){a.comments=c;a.reactions=b;return a})}).then(function(a){$(".comments").empty();a.comments.forEach(function(b){$(".comments").append($('<div class="comment"></div>').append($('<h2 class="name">').text(b.from.name),$('<p class="time"></p>').text(Math.floor((new Date()-new Date(b.created_time))/1000/60)+" min. ago"),$("<p></p>").text(b.message)))});$(".reactionGroup").hide();Object.keys(a.reactions).forEach(function(b){$(".reactionGroup."+b).show();$(".reactionGroup."+b).find(".count").text(a.reactions[b].toLocaleString())})}).always(function(){lastReloadTime=new Date()})}function onFrame(){requestAnimationFrame(onFrame);if(!lastReloadTime){return}var a=(reloadInterval-(new Date()-lastReloadTime));if(a<=0){refresh();return}countdownTime.attr("max",reloadInterval).val(a)}FB.init({appId:fbAppId,version:"v2.7",status:true});function loadConfig(){if(!localStorage.config){document.location.href="/"}return JSON.parse(localStorage.config)}function saveConfig(a){localStorage.config=JSON.stringify(a)}function setConfigItem(b,c){var a=loadConfig();a[b]=c;saveConfig(a);applyConfig(a)}function applyConfig(i){if(i!==null||i!=null){var h=i.fontColor,g=i.backgroundColor,n=i.fontFamily,m=i.readerStyle,l=i.textWeight,k=i.textTransform,j=h+" "+g+" "+n+" "+m+" "+l+" "+k;$("body").removeAttr("class").addClass(j)}launchFullscreen(document.documentElement,i.fullscreen)}function getURLQuery(a){var c=window.location.search.substring(1);var d=c.split("&");for(var b=0;b<d.length;b++){var e=d[b].split("=");if(e[0]==a){return e[1]}}return(false)}function launchFullscreen(a,b){if(b==false){$(".fullscreen").addClass("fa-compress").removeClass("fa-expand");if(a.requestFullscreen){a.requestFullscreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen()}else{if(a.msRequestFullscreen){a.msRequestFullscreen()}}}}}else{if(b==true){$(".fullscreen").addClass("fa-expand").removeClass("fa-compress");if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else{if(a.msCancelFullscreen){a.msCancelFullscreen()}}}}}}};